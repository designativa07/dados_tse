<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Candidato - Sistema Eleitoral TSE</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .perfil-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .perfil-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .candidate-photo-container {
            flex-shrink: 0;
        }

        .candidate-photo {
            width: 161px;
            height: 225px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .no-photo-placeholder {
            width: 161px;
            height: 225px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: rgba(255, 255, 255, 0.7);
        }

        .candidate-info {
            flex: 1;
        }

        .perfil-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .perfil-header .cargo {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .perfil-header .partido {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 500;
        }

        .perfil-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .perfil-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e5e9;
        }

        .perfil-card h3 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #34495e;
            min-width: 150px;
        }

        .info-value {
            color: #2c3e50;
            text-align: right;
            flex: 1;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .back-button {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #2980b9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .no-data {
            color: #95a5a6;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-deferido {
            background: #d4edda;
            color: #155724;
        }

        .status-indeferido {
            background: #f8d7da;
            color: #721c24;
        }

        .status-renuncia {
            background: #fff3cd;
            color: #856404;
        }

        .status-pendente {
            background: #cce5ff;
            color: #004085;
        }

        .currency-value {
            font-weight: 600;
            color: #27ae60;
        }

        .demographic-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .rede-social-grupo {
            margin-bottom: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
        }

        .rede-social-header {
            background: #f8f9fa;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e1e5e9;
        }

        .rede-social-tipo {
            font-weight: 600;
            color: #2c3e50;
            text-transform: capitalize;
        }

        .rede-social-count {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .rede-social-links {
            padding: 0;
        }

        .rede-social-item {
            border-bottom: 1px solid #f1f3f4;
        }

        .rede-social-item:last-child {
            border-bottom: none;
        }

        .rede-social-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: #2c3e50;
            transition: background-color 0.2s;
            gap: 10px;
        }

        .rede-social-link:hover {
            background: #f8f9fa;
            text-decoration: none;
            color: #2c3e50;
        }

        /* Mapa de Calor */
        .mapa-calor-container {
            margin-top: 20px;
        }

        .mapa-calor-municipio {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
            min-width: 60px;
            transition: all 0.2s ease;
        }

        .mapa-calor-municipio:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .mapa-calor-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .mapa-calor-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .mapa-calor-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .mapa-calor-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .mapa-calor-stats h5 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .mapa-calor-stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .mapa-calor-stats-row:last-child {
            margin-bottom: 0;
        }

        .rede-social-url {
            flex: 1;
            font-size: 0.9em;
            word-break: break-all;
        }

        .rede-social-link i.fa-external-link-alt {
            color: #95a5a6;
            font-size: 0.8em;
        }

        /* Estilos para mapa de calor e votos por mesorregi√£o */
        .mapa-calor-full-width,
        .votos-mesorregiao-full-width {
            margin-top: 30px;
            width: 100%;
            max-width: none;
        }

        /* Estilos espec√≠ficos para o mapa de calor */
        .mapa-calor-container {
            margin-top: 20px;
        }

        #mapa-calor-interativo {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .mapa-calor-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .mapa-calor-control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mapa-calor-control-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .mapa-calor-control-group select,
        .mapa-calor-control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .mapa-calor-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .mapa-calor-stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .mapa-calor-stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .mapa-calor-stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .mapa-calor-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 200px;
        }

        .mapa-calor-legend h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1em;
        }

        .mapa-calor-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        .mapa-calor-legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 3px;
        }

        .loading-mapa {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading-mapa i {
            font-size: 2em;
            margin-bottom: 10px;
            color: #3498db;
        }

        .votos-mesorregiao-container {
            margin-top: 20px;
        }

        .mesorregiao-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .mesorregiao-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #e9ecef;
        }

        .mesorregiao-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .mesorregiao-table tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .mesorregiao-table tr.clickable {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .mesorregiao-table tr.clickable:hover {
            background: #e3f2fd;
        }

        .mesorregiao-table tr:last-child td {
            border-bottom: none;
        }

        .mesorregiao-nome {
            font-weight: 600;
            color: #2c3e50;
        }

        .mesorregiao-votos {
            font-weight: 600;
            color: #27ae60;
            text-align: right;
        }

        .mesorregiao-percentual {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .mesorregiao-municipios {
            color: #95a5a6;
            font-size: 0.85em;
        }

        .mesorregiao-expand-icon {
            color: #3498db;
            font-size: 0.9em;
            transition: transform 0.2s;
        }

        .mesorregiao-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .municipios-detalhes {
            display: none;
            background: #f8f9fa;
            border-top: 2px solid #3498db;
        }

        .municipios-detalhes.show {
            display: table-row !important;
            animation: slideDown 0.3s ease;
            background: #e3f2fd;
        }

        .municipios-detalhes td {
            padding: 0;
            border-bottom: none;
        }

        .municipios-container {
            padding: 20px;
            background: white;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }

            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        .municipios-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .municipios-table th {
            background: #e9ecef;
            color: #495057;
            font-weight: 600;
            padding: 10px 12px;
            text-align: left;
            font-size: 0.9em;
        }

        .municipios-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.9em;
        }

        .municipios-table tr:hover {
            background: #f8f9fa;
        }

        .municipio-nome {
            font-weight: 500;
            color: #2c3e50;
        }

        .municipio-votos {
            font-weight: 600;
            color: #27ae60;
            text-align: right;
        }

        .municipio-percentual {
            color: #7f8c8d;
            text-align: right;
        }

        .municipio-eleitores {
            color: #95a5a6;
            text-align: right;
        }

        .municipios-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .municipios-header h5 {
            color: #2c3e50;
            margin: 0 0 5px 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .municipios-header h5 i {
            color: #3498db;
            margin-right: 8px;
        }

        .posicao-municipio {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9em;
        }

        .municipio-percentual-total {
            color: #17a2b8;
            font-weight: 600;
            text-align: right;
        }

        .top-municipio {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
            border-left: 4px solid #ffc107;
        }

        .top-municipio .municipio-nome {
            font-weight: 700;
            color: #2c3e50;
        }

        .top-municipio .municipio-votos {
            color: #28a745;
            font-weight: 700;
        }

        .loading-municipios {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }

        .loading-municipios i {
            margin-right: 8px;
            color: #3498db;
        }

        .no-votos-mesorregiao {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
            font-style: italic;
        }

        .votos-mesorregiao-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .votos-mesorregiao-stats h5 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .votos-mesorregiao-stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .votos-mesorregiao-stats-row:last-child {
            margin-bottom: 0;
        }

        /* Responsividade para tabela de munic√≠pios */
        @media (max-width: 768px) {
            .municipios-table {
                font-size: 0.85rem;
            }

            .municipios-table th,
            .municipios-table td {
                padding: 8px 6px;
            }

            .municipios-header h5 {
                font-size: 1.1em;
            }

            .posicao-municipio {
                font-size: 0.8em;
            }

            .municipio-nome {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .municipios-table {
                font-size: 0.8rem;
            }

            .municipios-table th,
            .municipios-table td {
                padding: 6px 4px;
            }

            .municipios-container {
                padding: 15px 10px;
                margin: 5px;
            }
        }

        /* Perfil Demogr√°fico dos Eleitores - Correla√ß√£o */
        .perfil-demografico-full-width {
            margin-top: 20px;
        }

        .section-subtitle {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .demografico-charts-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 15px;
        }

        @media (max-width: 992px) {
            .demografico-charts-row {
                grid-template-columns: 1fr;
            }
        }

        .demografico-chart-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .demografico-chart-card h4 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .chart-wrapper-small {
            height: 200px;
            position: relative;
        }

        .loading-demografico {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }

        .loading-demografico i {
            margin-right: 8px;
            color: #3498db;
        }
    </style>
</head>

<body>
    <div class="perfil-container">
        <button class="back-button" onclick="voltar()">‚Üê Voltar</button>

        <div id="loading" class="loading">
            Carregando dados do candidato...
        </div>

        <div id="error" class="error" style="display: none;">
            Erro ao carregar dados do candidato.
        </div>

        <div id="perfil-content" style="display: none;">
            <div class="perfil-header">
                <div class="candidate-photo-container">
                    <img id="candidate-photo" src="" alt="Foto do candidato" class="candidate-photo"
                        style="display: none;">
                    <div id="no-photo-placeholder" class="no-photo-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="candidate-info">
                    <h1 id="candidato-nome"></h1>
                    <div class="cargo" id="candidato-cargo"></div>
                    <div class="partido" id="candidato-partido"></div>
                </div>
            </div>

            <div class="stats-grid" id="stats-grid">
                <!-- Estat√≠sticas ser√£o inseridas aqui -->
            </div>

            <div class="perfil-grid">
                <div class="perfil-card">
                    <h3>üìã Dados B√°sicos</h3>
                    <div id="dados-basicos">
                        <!-- Dados b√°sicos ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üèõÔ∏è Dados Eleitorais</h3>
                    <div id="dados-eleitorais">
                        <!-- Dados eleitorais ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üë§ Dados Pessoais</h3>
                    <div id="dados-pessoais">
                        <!-- Dados pessoais ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üéì Forma√ß√£o e Profiss√£o</h3>
                    <div id="dados-formacao">
                        <!-- Dados de forma√ß√£o ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üìä Dados TSE</h3>
                    <div id="dados-tse">
                        <!-- Dados TSE ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üó≥Ô∏è Resultados Eleitorais</h3>
                    <div id="resultados-eleitorais">
                        <!-- Resultados eleitorais ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üìã Situa√ß√£o da Candidatura</h3>
                    <div id="situacao-candidatura">
                        <!-- Situa√ß√£o da candidatura ser√° inserida aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üåç Dados Demogr√°ficos</h3>
                    <div id="dados-demograficos">
                        <!-- Dados demogr√°ficos ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üí∞ Campanha e Finan√ßas</h3>
                    <div id="dados-campanha">
                        <!-- Dados de campanha ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>‚öñÔ∏è Processos e Julgamentos</h3>
                    <div id="processos-julgamentos">
                        <!-- Processos e julgamentos ser√£o inseridos aqui -->
                    </div>
                </div>

                <div class="perfil-card">
                    <h3>üì± Redes Sociais</h3>
                    <div id="redes-sociais">
                        <!-- Redes sociais ser√£o inseridas aqui -->
                    </div>
                </div>

            </div>

            <!-- Se√ß√£o de Mapa de Calor - Fora do grid para ocupar toda a largura -->
            <div class="perfil-card mapa-calor-full-width">
                <h3>üó∫Ô∏è Mapa de Calor Eleitoral</h3>
                <div id="mapa-calor">
                    <!-- Mapa de calor ser√° inserido aqui -->
                </div>
            </div>

            <!-- Se√ß√£o de Votos por Mesorregi√£o - Fora do grid para ocupar toda a largura -->
            <div class="perfil-card votos-mesorregiao-full-width">
                <h3>üó∫Ô∏è Votos por Mesorregi√£o</h3>
                <div id="votos-mesorregiao">
                    <!-- Votos por mesorregi√£o ser√£o inseridos aqui -->
                </div>
            </div>

            <!-- Se√ß√£o de Perfil Demogr√°fico dos Eleitores - Correla√ß√£o com Votos -->
            <div class="perfil-card perfil-demografico-full-width" id="perfil-demografico-votos">
                <h3>üìä Perfil Demogr√°fico dos Eleitores que Votaram neste Candidato</h3>
                <p class="section-subtitle">Correla√ß√£o entre votos recebidos e perfil demogr√°fico das se√ß√µes eleitorais
                </p>

                <div class="demografico-charts-row">
                    <div class="demografico-chart-card">
                        <h4><i class="fas fa-venus-mars" style="color: #ec4899;"></i> Por G√™nero</h4>
                        <div class="chart-wrapper-small">
                            <canvas id="chart-correlacao-genero"></canvas>
                        </div>
                    </div>

                    <div class="demografico-chart-card">
                        <h4><i class="fas fa-graduation-cap" style="color: #667eea;"></i> Por Escolaridade</h4>
                        <div class="chart-wrapper-small">
                            <canvas id="chart-correlacao-escolaridade"></canvas>
                        </div>
                    </div>

                    <div class="demografico-chart-card">
                        <h4><i class="fas fa-birthday-cake" style="color: #10b981;"></i> Por Faixa Et√°ria</h4>
                        <div class="chart-wrapper-small">
                            <canvas id="chart-correlacao-faixa-etaria"></canvas>
                        </div>
                    </div>
                </div>

                <div id="demografico-correlacao-loading" class="loading-demografico">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados demogr√°ficos...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o global para voltar
        function voltar() {
            window.history.back();
        }

        // Fun√ß√£o global para toggle de munic√≠pios
        function toggleMunicipios(mesorregiaoId, index) {
            console.log('toggleMunicipios chamado:', mesorregiaoId, index);

            const detalhesRow = document.getElementById(`municipios-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const loading = document.getElementById(`loading-${index}`);
            const content = document.getElementById(`municipios-content-${index}`);

            console.log('Elementos encontrados:', {
                detalhesRow: !!detalhesRow,
                icon: !!icon,
                loading: !!loading,
                content: !!content
            });

            if (!detalhesRow || !icon) {
                console.error('Elementos n√£o encontrados!');
                console.log('Procurando por:', `municipios-${index}`, `icon-${index}`);
                return;
            }

            console.log('Estado atual da linha:', {
                hasShowClass: detalhesRow.classList.contains('show'),
                display: window.getComputedStyle(detalhesRow).display
            });

            if (detalhesRow.classList.contains('show')) {
                // Fechar
                console.log('Fechando se√ß√£o');
                detalhesRow.classList.remove('show');
                icon.classList.remove('expanded');
                icon.style.transform = 'rotate(0deg)';

                // Restaurar mapa para visualiza√ß√£o geral
                restaurarMapaGeral();
            } else {
                // Fechar outras se√ß√µes abertas primeiro
                document.querySelectorAll('.municipios-detalhes.show').forEach(row => {
                    if (row.id !== `municipios-${index}`) {
                        row.classList.remove('show');
                        const otherIcon = document.getElementById(`icon-${row.id.split('-')[1]}`);
                        if (otherIcon) {
                            otherIcon.classList.remove('expanded');
                            otherIcon.style.transform = 'rotate(0deg)';
                        }
                    }
                });

                // Abrir
                console.log('Abrindo se√ß√£o');
                detalhesRow.classList.add('show');
                icon.classList.add('expanded');
                icon.style.transform = 'rotate(90deg)';

                console.log('Classe adicionada:', detalhesRow.classList.contains('show'));
                console.log('Display ap√≥s adicionar classe:', window.getComputedStyle(detalhesRow).display);

                // Se ainda n√£o carregou os dados, carregar agora
                if (content && !content.querySelector('.municipios-table')) {
                    console.log('Carregando dados dos munic√≠pios');
                    console.log('Chamando carregarMunicipiosMesorregiao com:', mesorregiaoId, index);
                    carregarMunicipiosMesorregiao(mesorregiaoId, index);
                } else {
                    console.log('Dados j√° carregados ou content n√£o encontrado');
                }

                // Expandir mapa para mostrar munic√≠pios da mesorregi√£o
                expandirMapaMesorregiao(mesorregiaoId);
            }
        }

        // Fun√ß√£o global para carregar munic√≠pios
        function carregarMunicipiosMesorregiao(mesorregiaoId, index) {
            console.log('carregarMunicipiosMesorregiao chamado:', mesorregiaoId, index);

            const loading = document.getElementById(`loading-${index}`);
            const content = document.getElementById(`municipios-content-${index}`);

            console.log('Elementos encontrados:', {
                loading: !!loading,
                content: !!content
            });

            // Obter ID do candidato da URL
            const urlParams = new URLSearchParams(window.location.search);
            const candidatoId = urlParams.get('id');

            console.log('Fazendo requisi√ß√£o para:', `/api/regionais/votos-por-municipio/${candidatoId}/${mesorregiaoId}`);

            // Adicionar timeout para a requisi√ß√£o
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos

            fetch(`/api/regionais/votos-por-municipio/${candidatoId}/${mesorregiaoId}`, {
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Resposta recebida:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    loading.style.display = 'none';

                    if (data.success && data.data && data.data.length > 0) {
                        console.log('Exibindo munic√≠pios:', data.data.length);
                        exibirMunicipiosMesorregiao(data.data, index);
                    } else {
                        console.log('Nenhum munic√≠pio encontrado');
                        content.innerHTML = '<div class="no-data">Nenhum munic√≠pio com votos nesta mesorregi√£o</div>';
                    }
                    content.style.display = 'block';
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Erro ao carregar munic√≠pios:', error);
                    loading.style.display = 'none';
                    content.innerHTML = `<div class="no-data">Erro ao carregar munic√≠pios: ${error.message}</div>`;
                    content.style.display = 'block';
                });
        }

        // Fun√ß√£o para expandir mapa para uma mesorregi√£o espec√≠fica
        function expandirMapaMesorregiao(mesorregiaoId) {
            console.log('Expandindo mapa para mesorregi√£o:', mesorregiaoId);

            // Obter ID do candidato da URL
            const urlParams = new URLSearchParams(window.location.search);
            const candidatoId = urlParams.get('id');

            // Buscar dados dos munic√≠pios da mesorregi√£o
            fetch(`/api/regionais/votos-por-municipio/${candidatoId}/${mesorregiaoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.length > 0) {
                        atualizarMapaComMunicipios(data.data, data.mesorregiao);
                    } else {
                        console.warn('Nenhum munic√≠pio com votos nesta mesorregi√£o');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar dados da mesorregi√£o:', error);
                });
        }

        // Fun√ß√£o para atualizar mapa com dados dos munic√≠pios
        function atualizarMapaComMunicipios(municipios, mesorregiao) {
            console.log('Atualizando mapa com munic√≠pios:', municipios.length);

            // Verificar se o mapa existe
            if (typeof window.mapaCalor === 'undefined' || !window.mapaCalor) {
                console.error('Mapa n√£o inicializado');
                return;
            }

            const mapa = window.mapaCalor;

            // Limpar camadas existentes
            if (window.heatmapLayer) {
                mapa.removeLayer(window.heatmapLayer);
            }
            if (window.circulosLayer) {
                mapa.removeLayer(window.circulosLayer);
            }

            // Preparar dados para o mapa
            const dadosMapa = municipios.map(m => ({
                lat: parseFloat(m.latitude) || -27.2423, // Coordenada padr√£o de SC se n√£o tiver
                lng: parseFloat(m.longitude) || -50.2189,
                total_votos: parseInt(m.total_votos) || 0,
                municipio: m.municipio,
                percentual: m.percentual_eleitores || 0
            }));

            // Calcular centro da mesorregi√£o
            const lats = dadosMapa.map(d => d.lat);
            const lngs = dadosMapa.map(d => d.lng);
            const centroLat = (Math.min(...lats) + Math.max(...lats)) / 2;
            const centroLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;

            // Ajustar zoom e centro do mapa
            mapa.setView([centroLat, centroLng], 8);

            // Adicionar c√≠rculos para cada munic√≠pio
            const circulos = dadosMapa
                .filter(d => d.lat && d.lng && !isNaN(d.lat) && !isNaN(d.lng)) // Filtrar coordenadas v√°lidas
                .map(d => {
                    const raio = Math.max(5, Math.min(30, Math.sqrt(d.total_votos) * 0.5));
                    const cor = d.total_votos > 0 ? '#e74c3c' : '#95a5a6';

                    return L.circleMarker([d.lat, d.lng], {
                        radius: raio,
                        fillColor: cor,
                        color: '#fff',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    }).bindPopup(`
                        <div style="text-align: center;">
                            <strong>${d.municipio}</strong><br>
                            <span style="color: #e74c3c; font-weight: bold;">${d.total_votos.toLocaleString()} votos</span><br>
                            <small>${d.percentual}% dos eleitores</small>
                        </div>
                    `);
                });

            // Adicionar camada de c√≠rculos
            window.circulosLayer = L.layerGroup(circulos).addTo(mapa);

            // Atualizar estat√≠sticas do mapa
            atualizarEstatisticasMapa(dadosMapa, mesorregiao);
        }

        // Fun√ß√£o para restaurar mapa geral
        function restaurarMapaGeral() {
            console.log('Restaurando mapa geral');

            // Verificar se o mapa existe
            if (typeof window.mapaCalor === 'undefined' || !window.mapaCalor) {
                console.error('Mapa n√£o inicializado');
                return;
            }

            const mapa = window.mapaCalor;

            // Limpar camadas existentes
            if (window.heatmapLayer) {
                mapa.removeLayer(window.heatmapLayer);
            }
            if (window.circulosLayer) {
                mapa.removeLayer(window.circulosLayer);
            }

            // Restaurar centro e zoom originais
            mapa.setView([-27.2423, -50.2189], 7);

            // Recarregar dados originais do mapa
            if (window.dadosMapaOriginais) {
                recarregarMapaOriginal();
            }
        }

        // Fun√ß√£o para recarregar mapa original
        function recarregarMapaOriginal() {
            const dadosMapa = window.dadosMapaOriginais;
            const mapa = window.mapaCalor;

            // Adicionar c√≠rculos originais
            const circulos = dadosMapa
                .filter(d => d.lat && d.lng && !isNaN(d.lat) && !isNaN(d.lng)) // Filtrar coordenadas v√°lidas
                .map(d => {
                    const raio = Math.max(5, Math.min(30, Math.sqrt(d.total_votos) * 0.5));
                    const cor = d.total_votos > 0 ? '#e74c3c' : '#95a5a6';

                    return L.circleMarker([d.lat, d.lng], {
                        radius: raio,
                        fillColor: cor,
                        color: '#fff',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.6
                    }).bindPopup(`
                        <div style="text-align: center;">
                            <strong>${d.municipio}</strong><br>
                            <span style="color: #e74c3c; font-weight: bold;">${d.total_votos.toLocaleString()} votos</span><br>
                            <small>${d.percentual}% dos eleitores</small>
                        </div>
                    `);
                });

            // Adicionar camada de c√≠rculos
            window.circulosLayer = L.layerGroup(circulos).addTo(mapa);

            // Restaurar estat√≠sticas originais
            atualizarEstatisticasMapa(dadosMapa, 'Santa Catarina');
        }

        // Fun√ß√£o para atualizar estat√≠sticas do mapa
        function atualizarEstatisticasMapa(dadosMapa, regiao) {
            const totalVotos = dadosMapa.reduce((sum, v) => sum + v.total_votos, 0);
            const maxVotos = Math.max(...dadosMapa.map(v => v.total_votos));
            const minVotos = Math.min(...dadosMapa.map(v => v.total_votos));
            const mediaVotos = dadosMapa.length > 0 ? Math.round(totalVotos / dadosMapa.length) : 0;

            // Atualizar estat√≠sticas na interface
            const statsContainer = document.querySelector('.mapa-calor-stats');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="mapa-calor-stat-item">
                        <div class="stat-value">${totalVotos.toLocaleString()}</div>
                        <div class="stat-label">Total de Votos</div>
                    </div>
                    <div class="mapa-calor-stat-item">
                        <div class="stat-value">${dadosMapa.length}</div>
                        <div class="stat-label">Munic√≠pios</div>
                    </div>
                    <div class="mapa-calor-stat-item">
                        <div class="stat-value">${maxVotos.toLocaleString()}</div>
                        <div class="stat-label">Maior Vota√ß√£o</div>
                    </div>
                    <div class="mapa-calor-stat-item">
                        <div class="stat-value">${mediaVotos.toLocaleString()}</div>
                        <div class="stat-label">M√©dia por Munic√≠pio</div>
                    </div>
                    <div class="mapa-calor-stat-item">
                        <div class="stat-value">${regiao}</div>
                        <div class="stat-label">Regi√£o</div>
                    </div>
                `;
            }
        }

        // Fun√ß√£o global para exibir munic√≠pios
        function exibirMunicipiosMesorregiao(municipios, index) {
            console.log('exibirMunicipiosMesorregiao chamado:', municipios.length, 'munic√≠pios, index:', index);

            const content = document.getElementById(`municipios-content-${index}`);

            if (!content) {
                console.error('Elemento content n√£o encontrado:', `municipios-content-${index}`);
                return;
            }

            // Ordenar munic√≠pios por votos (maior para menor)
            municipios.sort((a, b) => parseInt(b.total_votos) - parseInt(a.total_votos));

            const totalVotos = municipios.reduce((sum, m) => sum + parseInt(m.total_votos), 0);

            let html = `
                <div class="municipios-header">
                    <h5><i class="fas fa-map-marker-alt"></i> Munic√≠pios da Mesorregi√£o</h5>
                    <p class="text-muted">Total de ${municipios.length} munic√≠pios com votos</p>
                </div>
                <table class="municipios-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Munic√≠pio</th>
                            <th style="text-align: right;">Votos</th>
                            <th style="text-align: right;">% do Total</th>
                            <th style="text-align: right;">% Eleitores</th>
                            <th style="text-align: right;">Eleitores</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            municipios.forEach((municipio, posicao) => {
                const votos = parseInt(municipio.total_votos);
                const eleitores = parseInt(municipio.eleitores_2024);
                const percentualEleitores = parseFloat(municipio.percentual_eleitores);
                const percentualTotal = totalVotos > 0 ? ((votos / totalVotos) * 100).toFixed(1) : 0;

                // Destaque para os top 3
                const isTop3 = posicao < 3;
                const rowClass = isTop3 ? 'top-municipio' : '';

                html += `
                    <tr class="${rowClass}">
                        <td>
                            <span class="posicao-municipio">${posicao + 1}¬∫</span>
                        </td>
                        <td>
                            <span class="municipio-nome">${municipio.municipio}</span>
                            ${isTop3 ? '<i class="fas fa-trophy text-warning ms-1"></i>' : ''}
                        </td>
                        <td>
                            <span class="municipio-votos">${votos.toLocaleString('pt-BR')}</span>
                        </td>
                        <td>
                            <span class="municipio-percentual-total">${percentualTotal}%</span>
                        </td>
                        <td>
                            <span class="municipio-percentual">${percentualEleitores}%</span>
                        </td>
                        <td>
                            <span class="municipio-eleitores">${eleitores.toLocaleString('pt-BR')}</span>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            console.log('HTML gerado, inserindo no content...');
            content.innerHTML = html;
            console.log('HTML inserido com sucesso!');
        }

        // Fun√ß√£o principal
        (async function () {
            // Obter ID do candidato da URL
            const urlParams = new URLSearchParams(window.location.search);
            const candidatoId = urlParams.get('id');

            if (!candidatoId) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'ID do candidato n√£o fornecido.';
                return;
            }

            // Carregar dados do candidato
            async function carregarPerfilCandidato() {
                try {
                    const response = await fetch(`/api/candidatos/${candidatoId}`);
                    const data = await response.json();

                    if (response.ok) {
                        exibirPerfil(data);
                    } else {
                        throw new Error(data.error || 'Erro ao carregar dados');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = 'Erro ao carregar dados do candidato: ' + error.message;
                }
            }

            function exibirPerfil(candidato) {
                // Ocultar loading e mostrar conte√∫do
                document.getElementById('loading').style.display = 'none';
                document.getElementById('perfil-content').style.display = 'block';

                // Preencher cabe√ßalho
                // Usar nome na urna se dispon√≠vel, sen√£o usar nome completo
                const nomeExibir = candidato.nome_urna && candidato.nome_urna !== 'N/A' && candidato.nome_urna !== '#NULO'
                    ? candidato.nome_urna
                    : candidato.nome || 'Nome n√£o dispon√≠vel';

                document.getElementById('candidato-nome').textContent = nomeExibir;
                document.getElementById('candidato-cargo').textContent = candidato.cargo || 'Cargo n√£o informado';
                document.getElementById('candidato-partido').textContent = candidato.sigla_partido || candidato.partido || 'Partido n√£o informado';

                // Exibir foto do candidato
                exibirFotoCandidato(candidato);

                // Preencher estat√≠sticas
                preencherEstatisticas(candidato);

                // Preencher se√ß√µes
                preencherDadosBasicos(candidato);
                preencherDadosEleitorais(candidato);
                preencherDadosPessoais(candidato);
                preencherDadosFormacao(candidato);
                preencherDadosTSE(candidato);
                preencherResultadosEleitorais(candidato);
                preencherSituacaoCandidatura(candidato);
                preencherDadosDemograficos(candidato);
                preencherDadosCampanha(candidato);
                preencherProcessosJulgamentos(candidato);
                preencherRedesSociais(candidato);
                preencherMapaCalor(candidato);
                preencherVotosMesorregiao(candidato);
            }

            function exibirFotoCandidato(candidato) {
                const photoImg = document.getElementById('candidate-photo');
                const noPhotoPlaceholder = document.getElementById('no-photo-placeholder');

                if (candidato.foto) {
                    // Candidato tem foto - usar diretamente do campo foto
                    photoImg.src = `/fotos_candidatos/${candidato.foto}`;
                    photoImg.alt = `Foto de ${candidato.nome}`;
                    photoImg.style.display = 'block';
                    noPhotoPlaceholder.style.display = 'none';

                    // Tratar erro de carregamento da imagem
                    photoImg.onerror = function () {
                        console.log('Erro ao carregar foto:', candidato.foto);
                        photoImg.style.display = 'none';
                        noPhotoPlaceholder.style.display = 'flex';
                    };
                } else {
                    // Candidato n√£o tem foto
                    photoImg.style.display = 'none';
                    noPhotoPlaceholder.style.display = 'flex';
                }
            }

            function preencherEstatisticas(candidato) {
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${candidato.total_votos || 0}</div>
                    <div class="stat-label">Total de Votos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${candidato.total_municipios || 0}</div>
                    <div class="stat-label">Munic√≠pios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card">
                        <div class="stat-number">${candidato.total_zonas || 0}</div>
                        <div class="stat-label">Zonas Eleitorais</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${candidato.total_secoes || 0}</div>
                    <div class="stat-label">Se√ß√µes</div>
                </div>
            `;
            }

            function preencherDadosBasicos(candidato) {
                const container = document.getElementById('dados-basicos');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Nome Completo:</span>
                    <span class="info-value">${candidato.nome || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Nome na Urna:</span>
                    <span class="info-value">${candidato.nome_urna || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Nome Social:</span>
                    <span class="info-value">${candidato.nome_social || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">N√∫mero:</span>
                    <span class="info-value">${candidato.numero || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Cargo:</span>
                    <span class="info-value">${candidato.cargo || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${candidato.email || 'N/A'}</span>
                </div>
            `;
            }

            function preencherDadosEleitorais(candidato) {
                const container = document.getElementById('dados-eleitorais');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Partido:</span>
                    <span class="info-value">${candidato.partido || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Sigla do Partido:</span>
                    <span class="info-value">${candidato.sigla_partido || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">N√∫mero do Partido:</span>
                    <span class="info-value">${candidato.numero_partido || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tipo de Agremia√ß√£o:</span>
                    <span class="info-value">${candidato.tipo_agremiacao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Federa√ß√£o:</span>
                    <span class="info-value">${candidato.nome_federacao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Coliga√ß√£o:</span>
                    <span class="info-value">${candidato.nome_coligacao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o:</span>
                    <span class="info-value">${candidato.descricao_situacao_candidatura || 'N/A'}</span>
                </div>
            `;
            }

            function preencherDadosPessoais(candidato) {
                const container = document.getElementById('dados-pessoais');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Data de Nascimento:</span>
                    <span class="info-value">${candidato.data_nascimento || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">UF de Nascimento:</span>
                    <span class="info-value">${candidato.uf_nascimento || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">G√™nero:</span>
                    <span class="info-value">${candidato.descricao_genero || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Estado Civil:</span>
                    <span class="info-value">${candidato.descricao_estado_civil || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Cor/Ra√ßa:</span>
                    <span class="info-value">${candidato.descricao_cor_raca || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">T√≠tulo Eleitoral:</span>
                    <span class="info-value">${candidato.titulo_eleitoral || 'N/A'}</span>
                </div>
            `;
            }

            function preencherDadosFormacao(candidato) {
                const container = document.getElementById('dados-formacao');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Grau de Instru√ß√£o:</span>
                    <span class="info-value">${candidato.descricao_grau_instrucao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ocupa√ß√£o:</span>
                    <span class="info-value">${candidato.descricao_ocupacao || 'N/A'}</span>
                </div>
            `;
            }

            function preencherDadosTSE(candidato) {
                const container = document.getElementById('dados-tse');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Sequencial TSE:</span>
                    <span class="info-value">${candidato.sequencial_candidato || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">C√≥digo do Cargo:</span>
                    <span class="info-value">${candidato.codigo_cargo || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">C√≥digo da Elei√ß√£o:</span>
                    <span class="info-value">${candidato.codigo_eleicao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Descri√ß√£o da Elei√ß√£o:</span>
                    <span class="info-value">${candidato.descricao_eleicao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Data da Elei√ß√£o:</span>
                    <span class="info-value">${candidato.data_eleicao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tipo da Elei√ß√£o:</span>
                    <span class="info-value">${candidato.tipo_eleicao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Turno:</span>
                    <span class="info-value">${candidato.numero_turno || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Abrang√™ncia:</span>
                    <span class="info-value">${candidato.tipo_abrangencia || 'N/A'}</span>
                </div>
            `;
            }

            function preencherResultadosEleitorais(candidato) {
                const container = document.getElementById('resultados-eleitorais');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Total de Votos:</span>
                    <span class="info-value">${(candidato.total_votos || 0).toLocaleString('pt-BR')}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Munic√≠pios:</span>
                    <span class="info-value">${candidato.total_municipios || 0}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Zonas Eleitorais:</span>
                    <span class="info-value">${candidato.total_zonas || 0}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Se√ß√µes:</span>
                    <span class="info-value">${candidato.total_secoes || 0}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">M√©dia por Se√ß√£o:</span>
                    <span class="info-value">${candidato.media_votos_por_secao ? candidato.media_votos_por_secao.toFixed(2) : 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o na Totaliza√ß√£o:</span>
                    <span class="info-value">${candidato.descricao_situacao_totalizacao_turno || 'N/A'}</span>
                </div>
            `;
            }

            function preencherSituacaoCandidatura(candidato) {
                const container = document.getElementById('situacao-candidatura');

                // Fun√ß√£o para criar badge de status
                function criarStatusBadge(status) {
                    if (!status || status === 'N/A') return 'N/A';

                    const statusLower = status.toLowerCase();
                    let classe = 'status-badge';

                    if (statusLower.includes('deferido')) classe += ' status-deferido';
                    else if (statusLower.includes('indeferido')) classe += ' status-indeferido';
                    else if (statusLower.includes('ren√∫ncia') || statusLower.includes('renuncia')) classe += ' status-renuncia';
                    else if (statusLower.includes('pendente')) classe += ' status-pendente';

                    return `<span class="${classe}">${status}</span>`;
                }

                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Detalhe da Situa√ß√£o:</span>
                    <span class="info-value">${criarStatusBadge(candidato.ds_detalhe_situacao_cand)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o no Pleito:</span>
                    <span class="info-value">${criarStatusBadge(candidato.ds_situacao_candidato_pleito)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o na Urna:</span>
                    <span class="info-value">${criarStatusBadge(candidato.ds_situacao_candidato_urna)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Inserido na Urna:</span>
                    <span class="info-value">${candidato.st_candidato_inserido_urna === 'SIM' ? '‚úÖ Sim' : candidato.st_candidato_inserido_urna === 'N√ÉO' ? '‚ùå N√£o' : 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tipo de Destina√ß√£o:</span>
                    <span class="info-value">${candidato.nm_tipo_destinacao_votos || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o na Totaliza√ß√£o:</span>
                    <span class="info-value">${criarStatusBadge(candidato.ds_situacao_candidato_tot)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Presta√ß√£o de Contas:</span>
                    <span class="info-value">${candidato.st_prest_contas === 'S' ? '‚úÖ Sim' : candidato.st_prest_contas === 'N' ? '‚ùå N√£o' : 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Substitu√≠do:</span>
                    <span class="info-value">${candidato.st_substituido === 'S' ? '‚úÖ Sim' : candidato.st_substituido === 'N' ? '‚ùå N√£o' : 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Data de Aceite:</span>
                    <span class="info-value">${candidato.dt_aceite_candidatura || 'N/A'}</span>
                </div>
            `;
            }

            function preencherDadosDemograficos(candidato) {
                const container = document.getElementById('dados-demograficos');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Nacionalidade:</span>
                    <span class="info-value">${candidato.ds_nacionalidade || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Munic√≠pio de Nascimento:</span>
                    <span class="info-value">${candidato.nm_municipio_nascimento || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Idade na Posse:</span>
                    <span class="info-value">${candidato.nr_idade_data_posse && candidato.nr_idade_data_posse > 0 ? candidato.nr_idade_data_posse + ' anos' : 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o Quilombola:</span>
                    <span class="info-value">${candidato.st_quilombola || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Etnia Ind√≠gena:</span>
                    <span class="info-value">${candidato.ds_etnia_indigena || 'N/A'}</span>
                </div>
            `;
            }

            function preencherDadosCampanha(candidato) {
                const container = document.getElementById('dados-campanha');
                const despesaMaxima = candidato.vr_despesa_max_campanha ?
                    `R$ ${parseFloat(candidato.vr_despesa_max_campanha).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : 'N/A';

                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Despesa M√°xima:</span>
                    <span class="info-value currency-value">${despesaMaxima}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Reelei√ß√£o:</span>
                    <span class="info-value">${candidato.st_reeleicao === 'S' ? '‚úÖ Sim' : candidato.st_reeleicao === 'N' ? '‚ùå N√£o' : 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Declarar Bens:</span>
                    <span class="info-value">${candidato.st_declarar_bens === 'S' ? '‚úÖ Sim' : candidato.st_declarar_bens === 'N' ? '‚ùå N√£o' : 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Protocolo Candidatura:</span>
                    <span class="info-value">${candidato.nr_protocolo_candidatura || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">N√∫mero do Processo:</span>
                    <span class="info-value">${candidato.nr_processo || 'N/A'}</span>
                </div>
            `;
            }

            function preencherProcessosJulgamentos(candidato) {
                const container = document.getElementById('processos-julgamentos');
                container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o do Julgamento:</span>
                    <span class="info-value">${candidato.ds_situacao_julgamento || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Julgamento no Pleito:</span>
                    <span class="info-value">${candidato.ds_situacao_julgamento_pleito || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Julgamento na Urna:</span>
                    <span class="info-value">${candidato.ds_situacao_julgamento_urna || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o da Cassa√ß√£o:</span>
                    <span class="info-value">${candidato.ds_situacao_cassacao || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Cassa√ß√£o na M√≠dia:</span>
                    <span class="info-value">${candidato.ds_situacao_cassacao_midia || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Situa√ß√£o do Diploma:</span>
                    <span class="info-value">${candidato.ds_situacao_diploma || 'N/A'}</span>
                </div>
            `;
            }

            function preencherRedesSociais(candidato) {
                const container = document.getElementById('redes-sociais');

                if (!candidato.redes_sociais || candidato.redes_sociais.length === 0) {
                    container.innerHTML = '<div class="no-data">Nenhuma rede social cadastrada</div>';
                    return;
                }

                // Fun√ß√£o para obter √≠cone da rede social
                const obterIconeRedeSocial = (tipo) => {
                    const icones = {
                        'FACEBOOK': 'fab fa-facebook-f',
                        'INSTAGRAM': 'fab fa-instagram',
                        'TWITTER': 'fab fa-twitter',
                        'YOUTUBE': 'fab fa-youtube',
                        'LINKEDIN': 'fab fa-linkedin-in',
                        'TIKTOK': 'fab fa-tiktok',
                        'WHATSAPP': 'fab fa-whatsapp',
                        'TELEGRAM': 'fab fa-telegram-plane',
                        'SITE_PESSOAL': 'fas fa-globe'
                    };
                    return icones[tipo] || 'fas fa-link';
                };

                // Fun√ß√£o para obter cor da rede social
                const obterCorRedeSocial = (tipo) => {
                    const cores = {
                        'FACEBOOK': '#1877f2',
                        'INSTAGRAM': '#e4405f',
                        'TWITTER': '#1da1f2',
                        'YOUTUBE': '#ff0000',
                        'LINKEDIN': '#0077b5',
                        'TIKTOK': '#000000',
                        'WHATSAPP': '#25d366',
                        'TELEGRAM': '#0088cc',
                        'SITE_PESSOAL': '#6c757d'
                    };
                    return cores[tipo] || '#6c757d';
                };

                // Agrupar redes sociais por tipo
                const redesAgrupadas = {};
                candidato.redes_sociais.forEach(rede => {
                    if (!redesAgrupadas[rede.tipo_rede_social]) {
                        redesAgrupadas[rede.tipo_rede_social] = [];
                    }
                    redesAgrupadas[rede.tipo_rede_social].push(rede);
                });

                let html = '';

                Object.keys(redesAgrupadas).forEach(tipo => {
                    const redes = redesAgrupadas[tipo];
                    const icone = obterIconeRedeSocial(tipo);
                    const cor = obterCorRedeSocial(tipo);

                    html += `
                    <div class="rede-social-grupo">
                        <div class="rede-social-header">
                            <i class="${icone}" style="color: ${cor}"></i>
                            <span class="rede-social-tipo">${tipo.replace('_', ' ')}</span>
                            <span class="rede-social-count">(${redes.length})</span>
                        </div>
                        <div class="rede-social-links">
                `;

                    redes.forEach(rede => {
                        html += `
                        <div class="rede-social-item">
                            <a href="${rede.url}" target="_blank" rel="noopener noreferrer" class="rede-social-link">
                                <i class="${icone}" style="color: ${cor}"></i>
                                <span class="rede-social-url">${rede.url}</span>
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    `;
                    });

                    html += `
                        </div>
                    </div>
                `;
                });

                container.innerHTML = html;
            }

            function preencherMapaCalor(candidato) {
                const container = document.getElementById('mapa-calor');

                if (!candidato.total_votos || candidato.total_votos === 0) {
                    container.innerHTML = '<div class="no-data">Nenhum voto registrado para este candidato</div>';
                    return;
                }

                // Mostrar loading
                container.innerHTML = `
                <div class="loading-mapa">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando mapa de calor...</p>
                </div>
            `;

                // Buscar dados de votos por munic√≠pio
                fetch(`/api/votos/candidato/${candidato.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.votos && data.votos.length > 0) {
                            exibirMapaCalorInterativo(data.votos, candidato);
                        } else {
                            container.innerHTML = '<div class="no-data">Dados de votos por munic√≠pio n√£o dispon√≠veis</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar mapa de calor:', error);
                        container.innerHTML = '<div class="no-data">Erro ao carregar mapa de calor</div>';
                    });
            }

            function exibirMapaCalorInterativo(votos, candidato) {
                const container = document.getElementById('mapa-calor');

                // Coordenadas dos munic√≠pios de SC (lat, lon)
                const coordenadasSC = {
                    'FLORIAN√ìPOLIS': [-27.5954, -48.5480],
                    'JOINVILLE': [-26.3044, -48.8481],
                    'BLUMENAU': [-26.9194, -49.0661],
                    'S√ÉO JOS√â': [-27.6136, -48.6366],
                    'CRICI√öMA': [-28.6775, -49.3697],
                    'LAGES': [-27.8161, -50.3259],
                    'CHAPEC√ì': [-27.0964, -52.6181],
                    'ITAJA√ç': [-26.9078, -48.6619],
                    'PALHO√áA': [-27.6444, -48.6678],
                    'BALNE√ÅRIO CAMBORI√ö': [-26.9906, -48.6342],
                    'TUBAR√ÉO': [-28.4667, -49.0069],
                    'S√ÉO BENTO DO SUL': [-26.2500, -49.3833],
                    'ARARANGU√Å': [-28.9356, -49.4958],
                    'CA√áADOR': [-26.7758, -51.0139],
                    'VIDEIRA': [-27.0089, -51.1517],
                    'BRUSQUE': [-27.0978, -48.9128],
                    'S√ÉO MIGUEL DO OESTE': [-26.7250, -53.5181],
                    'CONC√ìRDIA': [-27.2333, -52.0167],
                    'JARAGU√Å DO SUL': [-26.4858, -49.0669],
                    'NOVA TRENTO': [-27.2858, -48.9308],
                    'INDAIAL': [-26.8989, -49.2317],
                    'S√ÉO JO√ÉO BATISTA': [-27.2761, -48.8489],
                    'BOMBINHAS': [-27.1389, -48.5089],
                    'PORTO BELO': [-27.1567, -48.5450],
                    'GAROPABA': [-28.0250, -48.6122],
                    'IMBITUBA': [-28.2400, -48.6700],
                    'LAGUNA': [-28.4833, -48.7833],
                    'TUBAR√ÉO': [-28.4667, -49.0069],
                    'CRICI√öMA': [-28.6775, -49.3697],
                    'SIDER√ìPOLIS': [-28.5981, -49.4267],
                    'URUSSANGA': [-28.5181, -49.3208],
                    'TURVO': [-28.9250, -49.6750],
                    'MELEIRO': [-28.8250, -49.6417],
                    'JACINTO MACHADO': [-28.9967, -49.7633],
                    'SOMBRIO': [-29.1081, -49.8081],
                    'TREZE DE MAIO': [-28.5581, -49.1417],
                    'MORRO DA FUMA√áA': [-28.6500, -49.2083],
                    'FORQUILHINHA': [-28.7458, -49.4708],
                    'NOVA VENEZA': [-28.6333, -49.5000],
                    'ORLEANS': [-28.3581, -49.2917],
                    'GRAVATAL': [-28.3333, -49.0333],
                    'ARMAGEM DOS B√öZIOS': [-28.2581, -48.9167],
                    'S√ÉO LUDGERO': [-28.3250, -49.1750],
                    'S√ÉO MARTINHO': [-28.1581, -48.9750],
                    'S√ÉO BONIF√ÅCIO': [-27.9000, -48.9250],
                    'ANIT√ÅPOLIS': [-27.9000, -49.1250],
                    'S√ÉO JOAQUIM': [-28.2939, -49.9317],
                    'BOM JARDIM DA SERRA': [-28.3333, -49.6250],
                    'BOCA√çNA DO SUL': [-27.7417, -49.9417],
                    'URUBICI': [-28.0167, -49.5917],
                    'BOM RETIRO': [-27.8000, -49.4833],
                    'CAMPO BELO DO SUL': [-27.9000, -50.7583],
                    'CURITIBANOS': [-27.2833, -50.5833],
                    'FREI ROG√âRIO': [-27.1750, -50.8083],
                    'MONTE CARLO': [-27.2250, -50.9750],
                    'PONTE ALTA': [-27.4833, -50.3750],
                    'S√ÉO CRIST√ìV√ÉO DO SUL': [-27.2667, -50.4417],
                    'VARGEM BONITA': [-27.0083, -51.7417],
                    'ABDON BATISTA': [-27.6167, -51.0167],
                    'BRUN√ìPOLIS': [-27.3083, -50.8667],
                    'CAP√ÉO ALTO': [-27.9333, -50.5083],
                    'CELSO RAMOS': [-27.6333, -51.3333],
                    'ERMO': [-28.1000, -49.4250],
                    'IBIAM': [-27.1833, -51.2333],
                    'IBICAR√â': [-27.0917, -51.3583],
                    'IMBUIA': [-27.4917, -49.4250],
                    'IMBUIA': [-27.4917, -49.4250],
                    'JABOR√Å': [-27.1750, -51.7333],
                    'JOS√â BOITEUX': [-26.9583, -49.6250],
                    'LAURO MULLER': [-28.3917, -49.3917],
                    'LEBON R√âGIS': [-26.9250, -50.6917],
                    'LOTTA': [-27.8583, -49.1750],
                    'PAINEL': [-27.9167, -50.1083],
                    'PALMEIRA': [-27.5833, -50.1583],
                    'PONTE SERRADA': [-26.8750, -52.0167],
                    'RIO RUFINO': [-27.8583, -49.7750],
                    'SANTA CEC√çLIA': [-26.9583, -50.4250],
                    'S√ÉO JOS√â DO CERRITO': [-27.6667, -50.5750],
                    'TUN√ÅPOLIS': [-26.9667, -53.6417],
                    'VARGEM': [-27.4833, -50.9750],
                    'ZORT√âA': [-27.4500, -51.5500]
                };

                // Preparar dados para o mapa
                const dadosMapa = [];
                const totalVotos = votos.reduce((sum, v) => sum + parseInt(v.total_votos), 0);
                const maxVotos = Math.max(...votos.map(v => parseInt(v.total_votos)));
                const minVotos = Math.min(...votos.map(v => parseInt(v.total_votos)));

                votos.forEach(voto => {
                    const municipio = voto.municipio.toUpperCase();
                    if (coordenadasSC[municipio]) {
                        const [lat, lon] = coordenadasSC[municipio];
                        dadosMapa.push({
                            lat: lat,
                            lon: lon,
                            municipio: voto.municipio,
                            votos: parseInt(voto.total_votos),
                            percentual: totalVotos > 0 ? ((parseInt(voto.total_votos) / totalVotos) * 100).toFixed(1) : 0
                        });
                    }
                });

                // Criar HTML do mapa
                const html = `
                <div class="mapa-calor-container">
                    <div class="mapa-calor-controls">
                        <div class="mapa-calor-control-group">
                            <label for="tipo-visualizacao">Tipo de Visualiza√ß√£o:</label>
                            <select id="tipo-visualizacao">
                                <option value="heatmap">Mapa de Calor</option>
                                <option value="circulos">C√≠rculos Proporcionais</option>
                                <option value="ambos">Ambos</option>
                            </select>
                        </div>
                        <div class="mapa-calor-control-group">
                            <label for="provedor-tiles">Provedor de Mapas:</label>
                            <select id="provedor-tiles">
                                <option value="0">CartoDB Light (Padr√£o)</option>
                                <option value="1">OpenStreetMap</option>
                                <option value="2">CartoDB Dark</option>
                                <option value="3">Stamen Terrain</option>
                            </select>
                        </div>
                        <div class="mapa-calor-control-group">
                            <label for="filtro-votos">Filtrar por M√≠nimo de Votos:</label>
                            <input type="range" id="filtro-votos" min="0" max="${maxVotos}" value="0" step="1">
                            <span id="filtro-valor">0</span> votos
                        </div>
                    </div>
                    
                    <div id="mapa-calor-interativo"></div>
                    <div id="mapa-status" style="display: none; text-align: center; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i>
                        <span id="mapa-status-text">Carregando mapa...</span>
                    </div>
                    
                    <div class="mapa-calor-stats">
                        <div class="mapa-calor-stat-item">
                            <div class="mapa-calor-stat-number">${dadosMapa.length}</div>
                            <div class="mapa-calor-stat-label">Munic√≠pios</div>
                        </div>
                        <div class="mapa-calor-stat-item">
                            <div class="mapa-calor-stat-number">${totalVotos.toLocaleString('pt-BR')}</div>
                            <div class="mapa-calor-stat-label">Total de Votos</div>
                        </div>
                        <div class="mapa-calor-stat-item">
                            <div class="mapa-calor-stat-number">${dadosMapa.length > 0 ? Math.round(totalVotos / dadosMapa.length) : 0}</div>
                            <div class="mapa-calor-stat-label">M√©dia por Munic√≠pio</div>
                        </div>
                        <div class="mapa-calor-stat-item">
                            <div class="mapa-calor-stat-number">${maxVotos}</div>
                            <div class="mapa-calor-stat-label">Maior N√∫mero</div>
                        </div>
                    </div>
                </div>
            `;

                container.innerHTML = html;

                // Inicializar mapa ap√≥s inserir HTML
                setTimeout(() => {
                    inicializarMapaCalor(dadosMapa, candidato);
                }, 100);
            }

            function inicializarMapaCalor(dadosMapa, candidato) {
                // Coordenadas do centro de Santa Catarina
                const centroSC = [-27.2423, -50.2189];

                // Armazenar dados originais para restaura√ß√£o
                window.dadosMapaOriginais = dadosMapa;

                // Criar mapa e torn√°-lo globalmente acess√≠vel
                window.mapaCalor = L.map('mapa-calor-interativo').setView(centroSC, 7);
                const mapa = window.mapaCalor;

                // Definir m√∫ltiplos provedores de tiles como fallback
                const tileProviders = [
                    {
                        name: 'CartoDB Light',
                        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                        attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
                        subdomains: 'abcd'
                    },
                    {
                        name: 'OpenStreetMap',
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        attribution: '¬© OpenStreetMap contributors',
                        subdomains: 'abc'
                    },
                    {
                        name: 'CartoDB Dark',
                        url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                        attribution: '¬© OpenStreetMap contributors, ¬© CARTO',
                        subdomains: 'abcd'
                    },
                    {
                        name: 'Stamen Terrain',
                        url: 'https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.png',
                        attribution: 'Map tiles by Stamen Design, CC BY 3.0 ‚Äî Map data ¬© OpenStreetMap contributors',
                        subdomains: 'abcd'
                    }
                ];

                let currentProviderIndex = 0;
                let currentTileLayer = null;

                // Fun√ß√£o para carregar um provedor de tiles espec√≠fico
                function tryLoadTileProvider(index) {
                    if (index >= tileProviders.length || index < 0) {
                        console.warn('√çndice de provedor inv√°lido');
                        updateStatus('Provedor de mapa inv√°lido.', 'error');
                        return;
                    }

                    const provider = tileProviders[index];
                    console.log(`Carregando provedor: ${provider.name}`);
                    updateStatus(`Carregando ${provider.name}...`, 'info');

                    const tileLayer = L.tileLayer(provider.url, {
                        attribution: provider.attribution,
                        maxZoom: 18,
                        subdomains: provider.subdomains,
                        errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                    });

                    // Remover camada anterior se existir
                    if (currentTileLayer) {
                        mapa.removeLayer(currentTileLayer);
                    }

                    // Adicionar nova camada
                    tileLayer.addTo(mapa);
                    currentTileLayer = tileLayer;

                    // Verificar se carregou com sucesso
                    tileLayer.on('tileerror', function () {
                        console.warn(`Erro ao carregar tiles do ${provider.name}`);
                        updateStatus(`Erro ao carregar ${provider.name}. Tente outro provedor.`, 'error');
                    });

                    // Verificar carregamento bem-sucedido
                    tileLayer.on('tileload', function () {
                        console.log(`Tile carregado com sucesso do ${provider.name}`);
                        updateStatus(`Mapa carregado com sucesso usando ${provider.name}`, 'success');
                        // Ocultar status ap√≥s 3 segundos
                        setTimeout(() => {
                            const statusDiv = document.getElementById('mapa-status');
                            if (statusDiv) {
                                statusDiv.style.display = 'none';
                            }
                        }, 3000);
                    });
                }

                // Fun√ß√£o para atualizar status
                function updateStatus(message, type = 'info') {
                    const statusDiv = document.getElementById('mapa-status');
                    const statusText = document.getElementById('mapa-status-text');

                    if (statusDiv && statusText) {
                        statusDiv.style.display = 'block';
                        statusText.textContent = message;

                        // Atualizar cor baseada no tipo
                        if (type === 'error') {
                            statusDiv.style.background = '#f8d7da';
                            statusDiv.style.borderColor = '#f5c6cb';
                            statusDiv.style.color = '#721c24';
                        } else if (type === 'success') {
                            statusDiv.style.background = '#d4edda';
                            statusDiv.style.borderColor = '#c3e6cb';
                            statusDiv.style.color = '#155724';
                        } else {
                            statusDiv.style.background = '#fff3cd';
                            statusDiv.style.borderColor = '#ffeaa7';
                            statusDiv.style.color = '#856404';
                        }
                    }
                }

                // Mostrar status inicial
                updateStatus('Carregando mapa...', 'info');

                // Carregar provedor padr√£o (CartoDB Light)
                tryLoadTileProvider(0);

                // Event listener para mudan√ßa de provedor
                document.getElementById('provedor-tiles').addEventListener('change', function () {
                    const providerIndex = parseInt(this.value);
                    updateStatus(`Carregando ${tileProviders[providerIndex].name}...`, 'info');
                    tryLoadTileProvider(providerIndex);
                });

                // Vari√°veis para controle
                let heatmapLayer = null;
                let circulosLayer = null;
                let tipoVisualizacao = 'heatmap';
                let dadosFiltrados = [...dadosMapa];

                // Fun√ß√£o para criar mapa de calor
                function criarHeatmap() {
                    if (window.heatmapLayer) {
                        mapa.removeLayer(window.heatmapLayer);
                    }

                    const pontos = dadosFiltrados.map(item => [item.lat, item.lon, item.votos]);

                    if (pontos.length > 0) {
                        window.heatmapLayer = L.heatLayer(pontos, {
                            radius: 30,
                            blur: 20,
                            maxZoom: 18,
                            gradient: {
                                0.4: 'blue',
                                0.6: 'cyan',
                                0.7: 'lime',
                                0.8: 'yellow',
                                1.0: 'red'
                            }
                        }).addTo(mapa);
                    }
                }

                // Fun√ß√£o para criar c√≠rculos proporcionais
                function criarCirculos() {
                    if (window.circulosLayer) {
                        mapa.removeLayer(window.circulosLayer);
                    }

                    circulosLayer = L.layerGroup();

                    dadosFiltrados.forEach(item => {
                        const raio = Math.max(8, Math.min(25, item.votos / 10));

                        const circulo = L.circleMarker([item.lat, item.lon], {
                            radius: raio,
                            fillColor: '#ff0000',
                            color: '#ff0000',
                            weight: 2,
                            opacity: 0.8,
                            fillOpacity: 0.6
                        });

                        circulo.bindPopup(`
                        <b>${item.municipio}</b><br>
                        Votos: ${item.votos.toLocaleString('pt-BR')}<br>
                        Percentual: ${item.percentual}%<br>
                        Candidato: ${candidato.nome || 'N/A'}
                    `);

                        circulosLayer.addLayer(circulo);
                    });

                    window.circulosLayer = circulosLayer.addTo(mapa);
                }

                // Fun√ß√£o para atualizar visualiza√ß√£o
                function atualizarVisualizacao() {
                    if (tipoVisualizacao === 'heatmap') {
                        criarHeatmap();
                    } else if (tipoVisualizacao === 'circulos') {
                        criarCirculos();
                    } else if (tipoVisualizacao === 'ambos') {
                        criarHeatmap();
                        criarCirculos();
                    }
                }

                // Event listeners
                document.getElementById('tipo-visualizacao').addEventListener('change', function () {
                    tipoVisualizacao = this.value;
                    atualizarVisualizacao();
                });

                document.getElementById('filtro-votos').addEventListener('input', function () {
                    const valor = parseInt(this.value);
                    document.getElementById('filtro-valor').textContent = valor;

                    // Filtrar dados baseado no valor
                    dadosFiltrados = dadosMapa.filter(item => item.votos >= valor);

                    // Atualizar visualiza√ß√£o
                    atualizarVisualizacao();
                });

                // Inicializar visualiza√ß√£o
                atualizarVisualizacao();
            }

            function preencherVotosMesorregiao(candidato) {
                const container = document.getElementById('votos-mesorregiao');

                if (!candidato.total_votos || candidato.total_votos === 0) {
                    container.innerHTML = '<div class="no-votos-mesorregiao">Nenhum voto registrado para este candidato</div>';
                    return;
                }

                // Buscar dados de votos por mesorregi√£o
                fetch(`/api/regionais/votos-por-mesorregiao/${candidato.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data && data.data.length > 0) {
                            exibirVotosMesorregiao(data.data, candidato);
                        } else {
                            container.innerHTML = '<div class="no-votos-mesorregiao">Dados de votos por mesorregi√£o n√£o dispon√≠veis</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar votos por mesorregi√£o:', error);
                        container.innerHTML = '<div class="no-votos-mesorregiao">Erro ao carregar votos por mesorregi√£o</div>';
                    });
            }

            function exibirVotosMesorregiao(mesorregioes, candidato) {
                const container = document.getElementById('votos-mesorregiao');

                // Calcular estat√≠sticas
                const totalVotos = mesorregioes.reduce((sum, m) => sum + parseInt(m.total_votos), 0);
                const totalMunicipios = mesorregioes.reduce((sum, m) => sum + parseInt(m.municipios_com_votos), 0);
                const mesorregiaoTop = mesorregioes[0];

                let html = `
                <div class="votos-mesorregiao-stats">
                    <h5>üìä Estat√≠sticas por Mesorregi√£o</h5>
                    <div class="votos-mesorregiao-stats-row">
                        <span>Total de votos:</span>
                        <strong>${totalVotos.toLocaleString('pt-BR')}</strong>
                    </div>
                    <div class="votos-mesorregiao-stats-row">
                        <span>Munic√≠pios com votos:</span>
                        <strong>${totalMunicipios}</strong>
                    </div>
                    <div class="votos-mesorregiao-stats-row">
                        <span>Melhor mesorregi√£o:</span>
                        <strong>${mesorregiaoTop.mesorregiao} (${parseInt(mesorregiaoTop.total_votos).toLocaleString('pt-BR')} votos)</strong>
                    </div>
                </div>
                
                <div class="votos-mesorregiao-container">
                    <table class="mesorregiao-table">
                        <thead>
                            <tr>
                                <th>Mesorregi√£o</th>
                                <th style="text-align: right;">Votos</th>
                                <th style="text-align: right;">Munic√≠pios</th>
                                <th style="text-align: right;">% Atendidos</th>
                                <th style="text-align: center;">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

                mesorregioes.forEach((mesorregiao, index) => {
                    const percentualAtendidos = parseFloat(mesorregiao.percentual_municipios_atendidos);
                    const totalVotos = parseInt(mesorregiao.total_votos);
                    const municipiosComVotos = parseInt(mesorregiao.municipios_com_votos);
                    const totalMunicipios = parseInt(mesorregiao.total_municipios_regiao);

                    // Usar o ID da mesorregi√£o
                    const mesorregiaoId = mesorregiao.mesorregiao_id;

                    html += `
                    <tr class="clickable" data-mesorregiao-id="${mesorregiaoId}" data-index="${index}" title="Clique para ver detalhes dos munic√≠pios">
                        <td>
                            <span class="mesorregiao-nome">${mesorregiao.mesorregiao}</span>
                        </td>
                        <td>
                            <span class="mesorregiao-votos">${totalVotos.toLocaleString('pt-BR')}</span>
                        </td>
                        <td>
                            <span class="mesorregiao-municipios">${municipiosComVotos}/${totalMunicipios}</span>
                        </td>
                        <td>
                            <span class="mesorregiao-percentual">${percentualAtendidos}%</span>
                        </td>
                        <td style="text-align: center;">
                            <i class="fas fa-chevron-right mesorregiao-expand-icon" id="icon-${index}"></i>
                        </td>
                    </tr>
                    <tr class="municipios-detalhes" id="municipios-${index}">
                        <td colspan="5">
                            <div class="municipios-container">
                                <div class="loading-municipios" id="loading-${index}">
                                    <i class="fas fa-spinner fa-spin"></i> Carregando munic√≠pios...
                                </div>
                                <div id="municipios-content-${index}" style="display: none;">
                                    <!-- Conte√∫do dos munic√≠pios ser√° inserido aqui -->
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                });

                html += `
                        </tbody>
                    </table>
                </div>
            `;

                container.innerHTML = html;

                // Adicionar event listeners ap√≥s inserir o HTML
                setTimeout(() => {
                    document.querySelectorAll('.mesorregiao-table tr.clickable').forEach((row) => {
                        row.addEventListener('click', function (e) {
                            e.preventDefault();
                            const mesorregiaoId = this.getAttribute('data-mesorregiao-id');
                            const index = parseInt(this.getAttribute('data-index'));
                            console.log('Clique via addEventListener:', mesorregiaoId, index);
                            toggleMunicipios(mesorregiaoId, index);
                        });
                    });
                }, 100);
            }

            // Fun√ß√£o para carregar correla√ß√£o demogr√°fica
            async function carregarCorrelacaoDemografica(candidatoId) {
                const loadingEl = document.getElementById('demografico-correlacao-loading');
                const section = document.getElementById('perfil-demografico-votos');

                if (!section) return;

                try {
                    loadingEl.style.display = 'block';

                    const response = await fetch(`/api/demografico/correlacao-votos/${candidatoId}`);
                    const data = await response.json();

                    if (data.success && data.correlacao) {
                        // Renderizar gr√°ficos
                        renderizarGraficoGeneroCorr(data.correlacao.genero);
                        renderizarGraficoEscolaridadeCorr(data.correlacao.escolaridade);
                        renderizarGraficoFaixaEtariaCorr(data.correlacao.faixa_etaria);
                        loadingEl.style.display = 'none';
                    } else {
                        loadingEl.innerHTML = '<i class="fas fa-info-circle"></i> Dados demogr√°ficos n√£o dispon√≠veis para este candidato.';
                    }
                } catch (error) {
                    console.error('Erro ao carregar correla√ß√£o demogr√°fica:', error);
                    loadingEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro ao carregar dados demogr√°ficos.';
                }
            }

            // Gr√°fico de G√™nero - Correla√ß√£o
            function renderizarGraficoGeneroCorr(dados) {
                const ctx = document.getElementById('chart-correlacao-genero');
                if (!ctx || !dados || dados.length === 0) return;

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: dados.map(d => d.categoria),
                        datasets: [{
                            data: dados.map(d => d.votos),
                            backgroundColor: ['#ec4899', '#3b82f6', '#9ca3af'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 10 } } }
                        }
                    }
                });
            }

            // Gr√°fico de Escolaridade - Correla√ß√£o  
            function renderizarGraficoEscolaridadeCorr(dados) {
                const ctx = document.getElementById('chart-correlacao-escolaridade');
                if (!ctx || !dados || dados.length === 0) return;

                const ordenados = dados.sort((a, b) => b.votos - a.votos).slice(0, 5);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ordenados.map(d => truncarTexto(d.categoria, 15)),
                        datasets: [{
                            label: 'Votos',
                            data: ordenados.map(d => d.votos),
                            backgroundColor: '#667eea',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { callback: (v) => formatarNumeroCompacto(v) } }
                        }
                    }
                });
            }

            // Gr√°fico de Faixa Et√°ria - Correla√ß√£o
            function renderizarGraficoFaixaEtariaCorr(dados) {
                const ctx = document.getElementById('chart-correlacao-faixa-etaria');
                if (!ctx || !dados || dados.length === 0) return;

                const ordenados = dados.filter(d => d.categoria).sort((a, b) => {
                    const numA = parseInt(a.categoria.match(/\d+/)?.[0]) || 0;
                    const numB = parseInt(b.categoria.match(/\d+/)?.[0]) || 0;
                    return numA - numB;
                });

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ordenados.map(d => d.categoria),
                        datasets: [{
                            label: 'Votos',
                            data: ordenados.map(d => d.votos),
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { callback: (v) => formatarNumeroCompacto(v) } }
                        }
                    }
                });
            }

            function truncarTexto(texto, max) {
                if (!texto) return '';
                return texto.length > max ? texto.substring(0, max) + '...' : texto;
            }

            function formatarNumeroCompacto(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
                return num.toString();
            }

            // Carregar dados do candidato
            await carregarPerfilCandidato();

            // Carregar correla√ß√£o demogr√°fica ap√≥s perfil carregado
            const demograficoParams = new URLSearchParams(window.location.search);
            const demograficoCandidatoId = demograficoParams.get('id');
            if (demograficoCandidatoId) {
                carregarCorrelacaoDemografica(demograficoCandidatoId);
            }
        })();
    </script>
</body>

</html>